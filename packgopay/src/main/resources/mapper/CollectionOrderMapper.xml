<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pakgopay.mapper.CollectionOrderMapper">

    <!-- ========================= -->
    <!-- ResultMap -->
    <!-- ========================= -->
    <resultMap id="CollectionOrderResultMap"
               type="com.pakgopay.mapper.dto.CollectionOrderDto">

        <!-- Primary key -->
        <id column="transaction_no" property="transactionNo" javaType="java.lang.String"/>
        <id column="merchant_order_no" property="merchantOrderNo" javaType="java.lang.String"/>

        <!-- Amounts -->
        <result column="amount" property="amount" javaType="java.math.BigDecimal"/>
        <result column="actual_amount" property="actualAmount" javaType="java.math.BigDecimal"/>
        <result column="floating_amount" property="floatingAmount" javaType="java.math.BigDecimal"/>

        <!-- Currency -->
        <result column="currency_type" property="currencyType" javaType="java.lang.String"/>

        <!-- User -->
        <result column="merchant_user_id" property="merchantUserId" javaType="java.lang.String"/>

        <!-- Callback info -->
        <result column="callback_token" property="callbackToken" javaType="java.lang.String"/>
        <result column="callback_url" property="callbackUrl" javaType="java.lang.String"/>
        <result column="callback_times" property="callbackTimes" javaType="java.lang.Integer"/>
        <result column="last_callback_time" property="lastCallbackTime" javaType="java.lang.Long"/>

        <!-- Merchant fees -->
        <result column="merchant_fixed_fee" property="merchantFixedFee" javaType="java.math.BigDecimal"/>
        <result column="merchant_rate" property="merchantRate" javaType="java.math.BigDecimal"/>
        <result column="merchant_fee" property="merchantFee" javaType="java.math.BigDecimal"/>

        <!-- Agent level 1 -->
        <result column="agent1_rate" property="agent1Rate" javaType="java.math.BigDecimal"/>
        <result column="agent1_fixed_fee" property="agent1FixedFee" javaType="java.math.BigDecimal"/>
        <result column="agent1_fee" property="agent1Fee" javaType="java.math.BigDecimal"/>

        <!-- Agent level 2 -->
        <result column="agent2_rate" property="agent2Rate" javaType="java.math.BigDecimal"/>
        <result column="agent2_fixed_fee" property="agent2FixedFee" javaType="java.math.BigDecimal"/>
        <result column="agent2_fee" property="agent2Fee" javaType="java.math.BigDecimal"/>

        <!-- Agent level 3 -->
        <result column="agent3_rate" property="agent3Rate" javaType="java.math.BigDecimal"/>
        <result column="agent3_fixed_fee" property="agent3FixedFee" javaType="java.math.BigDecimal"/>
        <result column="agent3_fee" property="agent3Fee" javaType="java.math.BigDecimal"/>

        <!-- Request info -->
        <result column="request_ip" property="requestIp" javaType="java.lang.String"/>
        <result column="operate_type" property="operateType" javaType="java.lang.String"/>
        <result column="remark" property="remark" javaType="java.lang.String"/>

        <!-- Time -->
        <result column="create_time" property="createTime" javaType="java.lang.Long"/>
        <result column="update_time" property="updateTime" javaType="java.lang.Long"/>

        <!-- Payment -->
        <result column="collection_mode" property="collectionMode" javaType="java.lang.Integer"/>
        <result column="payment_id" property="paymentId" javaType="java.lang.Long"/>
        <result column="payment_no" property="paymentNo" javaType="java.lang.String"/>

        <!-- Order status -->
        <result column="order_type" property="orderType" javaType="java.lang.Integer"/>
        <result column="callback_status" property="callbackStatus" javaType="java.lang.String"/>
        <result column="order_status" property="orderStatus" javaType="java.lang.String"/>

        <!-- Callback times -->
        <result column="request_time" property="requestTime" javaType="java.lang.Long"/>
        <result column="success_callback_time" property="successCallbackTime" javaType="java.lang.Long"/>

        <!-- Channel -->
        <result column="channel_id" property="channelId" javaType="java.lang.Long"/>

    </resultMap>

    <resultMap id="MerchantReportResultMap" type="com.pakgopay.mapper.dto.MerchantReportDto">
        <result column="merchant_user_id" property="userId"/>
        <result column="currency_type" property="currency"/>
        <result column="order_quantity" property="orderQuantity"/>
        <result column="success_quantity" property="successQuantity"/>
        <result column="merchant_fee" property="merchantFee"/>
        <result column="agent1_fee" property="agent1Fee"/>
        <result column="agent2_fee" property="agent2Fee"/>
        <result column="agent3_fee" property="agent3Fee"/>
    </resultMap>

    <resultMap id="ChannelReportResultMap" type="com.pakgopay.mapper.dto.ChannelReportDto">
        <result column="channel_id" property="channelId"/>
        <result column="currency_type" property="currency"/>
        <result column="order_quantity" property="orderQuantity"/>
        <result column="success_quantity" property="successQuantity"/>
        <result column="order_balance" property="orderBalance"/>
        <result column="merchant_fee" property="merchantFee"/>
        <result column="order_profit" property="orderProfit"/>
    </resultMap>

    <resultMap id="PaymentReportResultMap" type="com.pakgopay.mapper.dto.PaymentReportDto">
        <result column="payment_id" property="paymentId"/>
        <result column="currency_type" property="currency"/>
        <result column="order_quantity" property="orderQuantity"/>
        <result column="success_quantity" property="successQuantity"/>
        <result column="order_balance" property="orderBalance"/>
        <result column="merchant_fee" property="merchantFee"/>
        <result column="order_profit" property="orderProfit"/>
    </resultMap>

    <resultMap id="CurrencyReportResultMap" type="com.pakgopay.mapper.dto.CurrencyReportDto">
        <result column="currency_type" property="currency"/>
        <result column="order_quantity" property="orderQuantity"/>
        <result column="success_quantity" property="successQuantity"/>
        <result column="order_balance" property="orderBalance"/>
        <result column="merchant_fee" property="merchantFee"/>
        <result column="order_profit" property="orderProfit"/>
    </resultMap>


    <!-- Base columns -->
    <sql id="BaseColumns">
        transaction_no,merchant_order_no,amount,actual_amount,floating_amount,currency_type,merchant_user_id,callback_token,callback_url,callback_times,
        last_callback_time,merchant_fixed_fee,merchant_rate,merchant_fee,
        agent1_rate,agent1_fixed_fee,agent1_fee,agent2_rate,agent2_fixed_fee,agent2_fee,agent3_rate,agent3_fixed_fee,agent3_fee,
        request_ip,operate_type,remark,create_time,update_time,collection_mode,payment_id,order_type,callback_status,
        order_status,request_time,success_callback_time,channel_id,payment_no
    </sql>

    <!-- Insert order -->
    <insert id="insert">
        INSERT INTO collection_order (
        <include refid="BaseColumns"/>
        ) VALUES (
        #{transactionNo},#{merchantOrderNo},#{amount},#{actualAmount},#{floatingAmount},#{currencyType},#{merchantUserId},#{callbackToken},#{callbackUrl},#{callbackTimes},
        #{lastCallbackTime},#{merchantFixedFee},#{merchantRate},#{merchantFee},
        #{agent1Rate},#{agent1FixedFee},#{agent1Fee},#{agent2Rate},#{agent2FixedFee},#{agent2Fee},#{agent3Rate},#{agent3FixedFee},#{agent3Fee},
        #{requestIp},#{operateType},#{remark},#{createTime},#{updateTime},#{collectionMode},#{paymentId},#{orderType},#{callbackStatus},
        #{orderStatus},#{requestTime},#{successCallbackTime},#{channelId},#{paymentNo}
        )
    </insert>

    <select id="findByTransactionNo" parameterType="string" resultMap="CollectionOrderResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM collection_order
        WHERE transaction_no = #{transactionNo}
          AND create_time &gt;= #{startTime}
          AND create_time &lt; #{endTime}
        LIMIT 1
    </select>

    <select id="findByMerchantOrderNo" parameterType="string" resultMap="CollectionOrderResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM collection_order
        WHERE merchant_user_id = #{merchantUserId}
          AND merchant_order_no = #{merchantOrderNo}
          AND create_time &gt;= #{startTime}
          AND create_time &lt; #{endTime}
        LIMIT 1
    </select>

    <update id="updateByTransactionNo">
        UPDATE collection_order
        <set>
            <include refid="CollectionOrderUpdateSetDto"/>
        </set>
        WHERE transaction_no = #{dto.transactionNo}
          AND create_time &gt;= #{startTime}
          AND create_time &lt; #{endTime}
    </update>

    <update id="updateByTransactionNoWhenProcessing">
        UPDATE collection_order
        <set>
            <include refid="CollectionOrderUpdateSetDto"/>
        </set>
        WHERE transaction_no = #{dto.transactionNo}
          AND create_time &gt;= #{startTime}
          AND create_time &lt; #{endTime}
          AND order_status = #{currentStatus}
    </update>

    <sql id="CollectionOrderUpdateSetDto">
        <if test="dto.merchantOrderNo != null">merchant_order_no = #{dto.merchantOrderNo},</if>
        <if test="dto.amount != null">amount = #{dto.amount},</if>
        <if test="dto.actualAmount != null">actual_amount = #{dto.actualAmount},</if>
        <if test="dto.floatingAmount != null">floating_amount = #{dto.floatingAmount},</if>

        <if test="dto.currencyType != null and dto.currencyType != ''">currency_type = #{dto.currencyType},</if>

        <if test="dto.merchantUserId != null">merchant_user_id = #{dto.merchantUserId},</if>
        <if test="dto.paymentId != null">payment_id = #{dto.paymentId},</if>
        <if test="dto.paymentNo != null">payment_no = #{dto.paymentNo},</if>
        <if test="dto.channelId != null">channel_id = #{dto.channelId},</if>
        <if test="dto.collectionMode != null">collection_mode = #{dto.collectionMode},</if>
        <if test="dto.orderType != null">order_type = #{dto.orderType},</if>
        <if test="dto.requestIp != null">request_ip = #{dto.requestIp},</if>
        <if test="dto.operateType != null">operate_type = #{dto.operateType},</if>
        <if test="dto.remark != null">remark = #{dto.remark},</if>
        <if test="dto.requestTime != null">request_time = #{dto.requestTime},</if>
        <if test="dto.callbackTimes != null">callback_times = #{dto.callbackTimes},</if>

        <if test="dto.callbackToken != null">callback_token = #{dto.callbackToken},</if>
        <if test="dto.callbackUrl != null">callback_url = #{dto.callbackUrl},</if>
        <if test="dto.lastCallbackTime != null">last_callback_time = #{dto.lastCallbackTime},</if>

        <if test="dto.merchantFixedFee != null">merchant_fixed_fee = #{dto.merchantFixedFee},</if>
        <if test="dto.merchantRate != null">merchant_rate = #{dto.merchantRate},</if>
        <if test="dto.merchantFee != null">merchant_fee = #{dto.merchantFee},</if>
        <if test="dto.agent1Rate != null">agent1_rate = #{dto.agent1Rate},</if>
        <if test="dto.agent1FixedFee != null">agent1_fixed_fee = #{dto.agent1FixedFee},</if>
        <if test="dto.agent1Fee != null">agent1_fee = #{dto.agent1Fee},</if>
        <if test="dto.agent2Rate != null">agent2_rate = #{dto.agent2Rate},</if>
        <if test="dto.agent2FixedFee != null">agent2_fixed_fee = #{dto.agent2FixedFee},</if>
        <if test="dto.agent2Fee != null">agent2_fee = #{dto.agent2Fee},</if>
        <if test="dto.agent3Rate != null">agent3_rate = #{dto.agent3Rate},</if>
        <if test="dto.agent3FixedFee != null">agent3_fixed_fee = #{dto.agent3FixedFee},</if>
        <if test="dto.agent3Fee != null">agent3_fee = #{dto.agent3Fee},</if>

        <if test="dto.orderStatus != null">order_status = #{dto.orderStatus},</if>
        <if test="dto.callbackStatus != null">callback_status = #{dto.callbackStatus},</if>

        <if test="dto.successCallbackTime != null">success_callback_time = #{dto.successCallbackTime},</if>

        <if test="dto.updateTime != null">update_time = #{dto.updateTime},</if>
    </sql>

    <update id="increaseCallbackTimes">
        UPDATE collection_order
        SET
            callback_times = COALESCE(callback_times, 0) + #{increment},
            last_callback_time = #{lastCallbackTime},
            success_callback_time = CASE
                WHEN #{successCallbackTime} IS NOT NULL THEN #{successCallbackTime}
                ELSE success_callback_time
            END,
            update_time = #{lastCallbackTime}
        WHERE transaction_no = #{transactionNo}
          AND create_time &gt;= #{startTime}
          AND create_time &lt; #{endTime}
    </update>

    <update id="markTimeoutOrders">
        UPDATE collection_order
        SET
            order_status = #{timeoutStatus},
            update_time = #{updateTime},
            remark = #{remark}
        WHERE order_status = #{processingStatus}
          AND create_time &gt;= #{minTime}
          AND create_time &lt;= #{deadlineTime}
    </update>

    <select id="isExitMerchantOrderNo" resultType="java.lang.Integer">
        select
            count(1)
        from collection_order
        where merchant_user_id = #{merchantUserId}
          and merchant_order_no = #{merchantOrderNo}
          and create_time &gt;= #{startTime}
          and create_time &lt; #{endTime}
    </select>

    <select id="getCollectionOrderInfosByPaymentIds"
            resultMap="CollectionOrderResultMap">

        SELECT
        <include refid="BaseColumns"/>
        FROM collection_order
        <where>
            <if test="paymentIds != null and !paymentIds.isEmpty()">
                payment_id IN
                <foreach collection="paymentIds" item="pid" open="(" close=")" separator=",">
                    #{pid}
                </foreach>
            </if>
            <if test="paymentIds == null or paymentIds.isEmpty()">
                AND 1 = 0
            </if>
            AND create_time &gt;= #{startTime}
            AND create_time &lt;  #{endTime}
        </where>

    </select>

    <sql id="CommonReportAggColumns">
        COUNT(1) order_quantity,
        COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN 1 ELSE 0 END), 0) success_quantity,
        COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN merchant_fee ELSE 0 END), 0) merchant_fee,
        COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN agent1_fee ELSE 0 END), 0) agent1_fee,
        COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN agent2_fee ELSE 0 END), 0) agent2_fee,
        COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN agent3_fee ELSE 0 END), 0) agent3_fee
    </sql>

    <sql id="CommonReportAggColumnsWithBalance">
        COUNT(1) order_quantity,
        COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN 1 ELSE 0 END), 0) success_quantity,
        COALESCE(SUM(COALESCE(actual_amount, amount)), 0) order_balance,
        COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN merchant_fee ELSE 0 END), 0) merchant_fee,
        COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN merchant_fee ELSE 0 END), 0)
          - COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN agent1_fee ELSE 0 END), 0)
          - COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN agent2_fee ELSE 0 END), 0)
          - COALESCE(SUM(CASE WHEN order_status = #{successStatus} THEN agent3_fee ELSE 0 END), 0) order_profit
    </sql>

    <select id="listMerchantReportStatsBatch" resultMap="MerchantReportResultMap">
        <foreach collection="ranges" item="item" separator=" UNION ALL ">
            SELECT
                merchant_user_id,
                currency_type,
                <include refid="CommonReportAggColumns"/>
            FROM collection_order
            WHERE currency_type = #{item.currency}
              AND create_time &gt;= #{item.startTime}
              AND create_time &lt; #{item.endTime}
            GROUP BY merchant_user_id, currency_type
        </foreach>
    </select>

    <select id="listChannelReportStatsBatch" resultMap="ChannelReportResultMap">
        <foreach collection="ranges" item="item" separator=" UNION ALL ">
            SELECT
                channel_id,
                currency_type,
                <include refid="CommonReportAggColumnsWithBalance"/>
            FROM collection_order
            WHERE currency_type = #{item.currency}
              AND create_time &gt;= #{item.startTime}
              AND create_time &lt; #{item.endTime}
            GROUP BY channel_id, currency_type
        </foreach>
    </select>

    <select id="listPaymentReportStatsBatch" resultMap="PaymentReportResultMap">
        <foreach collection="ranges" item="item" separator=" UNION ALL ">
            SELECT
                payment_id,
                currency_type,
                <include refid="CommonReportAggColumnsWithBalance"/>
            FROM collection_order
            WHERE currency_type = #{item.currency}
              AND create_time &gt;= #{item.startTime}
              AND create_time &lt; #{item.endTime}
            GROUP BY payment_id, currency_type
        </foreach>
    </select>

    <select id="listCurrencyReportStatsBatch" resultMap="CurrencyReportResultMap">
        <foreach collection="ranges" item="item" separator=" UNION ALL ">
            SELECT
                currency_type,
                <include refid="CommonReportAggColumnsWithBalance"/>
            FROM collection_order
            WHERE currency_type = #{item.currency}
              AND create_time &gt;= #{item.startTime}
              AND create_time &lt; #{item.endTime}
            GROUP BY currency_type
        </foreach>
    </select>

    <select id="sumMerchantStatsByUserId" resultMap="MerchantReportResultMap">
        SELECT
            merchant_user_id,
            currency_type,
            <include refid="CommonReportAggColumns"/>
        FROM collection_order
        WHERE merchant_user_id = #{merchantUserId}
          AND currency_type = #{currency}
          AND create_time &gt;= #{startTime}
          AND create_time &lt; #{endTime}
        GROUP BY merchant_user_id, currency_type
    </select>

    <select id="countByQuery" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM collection_order
        <where>
            <if test="q != null and q.merchantUserId != null and q.merchantUserId != ''">
                merchant_user_id = #{q.merchantUserId}
            </if>
            <if test="q != null and q.transactionNo != null and q.transactionNo != ''">
                AND transaction_no = #{q.transactionNo}
            </if>
            <if test="q != null and q.merchantOrderNo != null and q.merchantOrderNo != ''">
                AND merchant_order_no = #{q.merchantOrderNo}
            </if>
            <if test="q != null and q.currencyType != null and q.currencyType != ''">
                AND currency_type = #{q.currencyType}
            </if>
            <if test="q != null and q.orderStatus != null and q.orderStatus != ''">
                AND order_status = #{q.orderStatus}
            </if>
            <if test="q != null and q.orderType != null">
                AND order_type = #{q.orderType}
            </if>
            <if test="q != null and q.amount != null">
                AND amount = #{q.amount}
            </if>
            <if test="q != null and q.channelId != null">
                AND channel_id = #{q.channelId}
            </if>
            <if test="q != null and q.startTime != null">
                AND create_time &gt;= #{q.startTime}
            </if>
            <if test="q != null and q.endTime != null">
                AND create_time &lt; #{q.endTime}
            </if>
        </where>
    </select>

    <select id="pageByQuery" resultMap="CollectionOrderResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM collection_order
        <where>
            <if test="q != null and q.merchantUserId != null and q.merchantUserId != ''">
                merchant_user_id = #{q.merchantUserId}
            </if>
            <if test="q != null and q.transactionNo != null and q.transactionNo != ''">
                AND transaction_no = #{q.transactionNo}
            </if>
            <if test="q != null and q.merchantOrderNo != null and q.merchantOrderNo != ''">
                AND merchant_order_no = #{q.merchantOrderNo}
            </if>
            <if test="q != null and q.currencyType != null and q.currencyType != ''">
                AND currency_type = #{q.currencyType}
            </if>
            <if test="q != null and q.orderStatus != null and q.orderStatus != ''">
                AND order_status = #{q.orderStatus}
            </if>
            <if test="q != null and q.orderType != null">
                AND order_type = #{q.orderType}
            </if>
            <if test="q != null and q.amount != null">
                AND amount = #{q.amount}
            </if>
            <if test="q != null and q.channelId != null">
                AND channel_id = #{q.channelId}
            </if>
            <if test="q != null and q.startTime != null">
                AND create_time &gt;= #{q.startTime}
            </if>
            <if test="q != null and q.endTime != null">
                AND create_time &lt; #{q.endTime}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{q.pageSize} OFFSET #{q.offset}
    </select>

</mapper>
