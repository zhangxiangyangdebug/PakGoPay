<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pakgopay.mapper.MerchantInfoMapper">

    <!-- 只在 resultMap 指定 javaType -->
    <resultMap id="MerchantInfoDtoMap" type="com.pakgopay.mapper.dto.MerchantInfoDto">

        <result column="user_id" property="userId" javaType="java.lang.String"/>
        <result column="parent_id" property="parentId" javaType="java.lang.String"/>

        <result column="merchant_name" property="merchantName" javaType="java.lang.String"/>

        <result column="support_type" property="supportType" javaType="java.lang.Integer"/>

        <result column="status" property="status" javaType="java.lang.Integer"/>
        <result column="risk_level" property="riskLevel" javaType="java.lang.Integer"/>
        <result column="notification_enable" property="notificationEnable" javaType="java.lang.Integer"/>

        <result column="create_time" property="createTime" javaType="java.lang.Long"/>
        <result column="create_by" property="createBy" javaType="java.lang.String"/>
        <result column="update_time" property="updateTime" javaType="java.lang.Long"/>
        <result column="update_by" property="updateBy" javaType="java.lang.String"/>

        <result column="collection_rate" property="collectionRate" javaType="java.math.BigDecimal"/>
        <result column="collection_fixed_fee" property="collectionFixedFee" javaType="java.math.BigDecimal"/>
        <result column="collection_max_fee" property="collectionMaxFee" javaType="java.math.BigDecimal"/>
        <result column="collection_min_fee" property="collectionMinFee" javaType="java.math.BigDecimal"/>

        <result column="pay_rate" property="payRate" javaType="java.math.BigDecimal"/>
        <result column="pay_fixed_fee" property="payFixedFee" javaType="java.math.BigDecimal"/>
        <result column="pay_max_fee" property="payMaxFee" javaType="java.math.BigDecimal"/>
        <result column="pay_min_fee" property="payMinFee" javaType="java.math.BigDecimal"/>

        <result column="version" property="version" javaType="java.lang.Integer"/>
        <result column="is_float" property="isFloat" javaType="java.lang.Integer"/>

        <result column="col_white_ips" property="colWhiteIps" javaType="java.lang.String"/>
        <result column="pay_white_ips" property="payWhiteIps" javaType="java.lang.String"/>
        <result column="channel_ids" property="channelIds" javaType="java.lang.String"/>

    </resultMap>

    <sql id="BaseColumns">
        user_id,
        parent_id,
        merchant_name,
        support_type,
        status,
        risk_level,
        notification_enable,
        create_time,
        create_by,
        update_time,
        update_by,
        collection_rate,
        collection_fixed_fee,
        collection_max_fee,
        collection_min_fee,
        pay_rate,
        pay_fixed_fee,
        pay_max_fee,
        pay_min_fee,
        version,
        is_float,
        col_white_ips,
        pay_white_ips,
        channel_ids
    </sql>

    <sql id="BaseColumnsForJoin">
        m.user_id,
        m.parent_id,
        m.merchant_name,
        m.support_type,
        m.status,
        m.risk_level,
        m.notification_enable,
        m.create_time,
        m.create_by,
        m.update_time,
        m.update_by,
        m.collection_rate,
        m.collection_fixed_fee,
        m.collection_max_fee,
        m.collection_min_fee,
        m.pay_rate,
        m.pay_fixed_fee,
        m.pay_max_fee,
        m.pay_min_fee,
        m.version,
        m.is_float,
        m.col_white_ips,
        m.pay_white_ips,
        m.channel_ids
    </sql>

    <!-- 1.findByUserId -->
    <select id="findByUserId" resultMap="MerchantInfoDtoMap">
        select <include refid="BaseColumns"/>
        from merchant_info
        where user_id = #{userId}
        limit 1
    </select>

    <insert id="insert" parameterType="com.pakgopay.mapper.dto.MerchantInfoDto">
        INSERT INTO merchant_info (
        <include refid="BaseColumns"/>
        ) VALUES (
        #{userId},
        #{parentId},
        #{merchantName},
        #{supportType},
        #{status},
        #{riskLevel},
        #{notificationEnable},
        #{createTime},
        #{createBy},
        #{updateTime},
        #{updateBy},
        #{collectionRate},
        #{collectionFixedFee},
        #{collectionMaxFee},
        #{collectionMinFee},
        #{payRate},
        #{payFixedFee},
        #{payMaxFee},
        #{payMinFee},
        #{version},
        #{isFloat},
        #{colWhiteIps},
        #{payWhiteIps},
        #{channelIds}
        )
    </insert>

    <update id="updateByUserId" parameterType="com.pakgopay.mapper.dto.MerchantInfoDto">
        UPDATE merchant_info
        <set>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="merchantName != null and merchantName != ''">merchant_name = #{merchantName},</if>
            <if test="supportType != null">support_type = #{supportType},</if>
            <if test="status != null">status = #{status},</if>
            <if test="riskLevel != null">risk_level = #{riskLevel},</if>
            <if test="notificationEnable != null">notification_enable = #{notificationEnable},</if>

            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>

            <if test="collectionRate != null">collection_rate = #{collectionRate},</if>
            <if test="collectionFixedFee != null">collection_fixed_fee = #{collectionFixedFee},</if>
            <if test="collectionMaxFee != null">collection_max_fee = #{collectionMaxFee},</if>
            <if test="collectionMinFee != null">collection_min_fee = #{collectionMinFee},</if>

            <if test="payRate != null">pay_rate = #{payRate},</if>
            <if test="payFixedFee != null">pay_fixed_fee = #{payFixedFee},</if>
            <if test="payMaxFee != null">pay_max_fee = #{payMaxFee},</if>
            <if test="payMinFee != null">pay_min_fee = #{payMinFee},</if>

            <if test="version != null">version = #{version},</if>

            <if test="isFloat != null">is_float = #{isFloat},</if>

            <if test="colWhiteIps != null and colWhiteIps != ''">col_white_ips = #{colWhiteIps},</if>
            <if test="payWhiteIps != null and payWhiteIps != ''">pay_white_ips = #{payWhiteIps},</if>

            <if test="channelIds != null and channelIds != ''">channel_ids = #{channelIds},</if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <!-- 3.upDatePayWhiteIpsByUserId -->
    <update id="upDatePayWhiteIpsByUserId">
        update merchant_info
        set pay_white_ips = #{payWhiteIps},
            update_time = now()
        where user_id = #{userId}
    </update>

    <!-- 4.upDateColWhiteIpsByUserId -->
    <update id="upDateColWhiteIpsByUserId">
        update merchant_info
        set col_white_ips = #{colWhiteIps},
            update_time = now()
        where user_id = #{userId}
    </update>

    <!-- 5.getEnableStatus -->
    <select id="getEnableStatus" resultType="java.lang.Integer">
        select status
        from merchant_info
        where user_id = #{userId}
            limit 1
    </select>

    <!-- 6.findByMerchantName -->
    <select id="findByMerchantName" resultMap="MerchantInfoDtoMap">
        select
        <include refid="BaseColumns"/>
        from merchant_info
        where merchant_name = #{merchantName}
        limit 1
    </select>

    <sql id="MerchantQueryWhere">
        <where>
            <if test="merchantName != null and merchantName != ''">AND m.merchant_name LIKE CONCAT('%', #{merchantName}, '%')</if>
            <if test="merchantUserId != null and merchantUserId != ''">AND m.user_id = #{merchantUserId}</if>
            <if test="status != null">AND m.status = #{status}</if>
            <if test="parentAgentId != null and parentAgentId != ''">AND m.parent_id = #{parentAgentId}</if>
            <if test="merchantUserName != null and merchantUserName != ''">AND ui.user_name LIKE CONCAT('%', #{merchantUserName}, '%')</if>
        </where>
    </sql>

    <select id="countByQuery"
            parameterType="com.pakgopay.data.entity.merchant.MerchantEntity"
            resultType="int">
        SELECT COUNT(1)
        FROM merchant_info m
        LEFT JOIN user_info ui ON ui.user_id = m.user_id
        <include refid="MerchantQueryWhere"/>
    </select>

    <select id="pageByQuery"
            parameterType="com.pakgopay.data.entity.merchant.MerchantEntity"
            resultMap="MerchantInfoDtoMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM merchant_info m
        LEFT JOIN user_info ui ON ui.user_id = m.user_id
        <include refid="MerchantQueryWhere"/>
        ORDER BY m.create_time DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

</mapper>
