<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pakgopay.mapper.AgentReportMapper">

    <!-- ResultMap (explicit javaType) -->
    <resultMap id="AgentReportResultMap" type="com.pakgopay.mapper.dto.AgentReportDto">

        <id column="user_id" property="userId" javaType="java.lang.String"/>

        <result column="agent_name" property="agentName" javaType="java.lang.String"/>
        <result column="order_type" property="orderType" javaType="java.lang.Integer"/>

        <result column="order_quantity" property="orderQuantity" javaType="java.lang.Long"/>
        <result column="success_quantity" property="successQuantity" javaType="java.lang.Long"/>

        <result column="currency" property="currency" javaType="java.lang.String"/>
        <result column="commission" property="commission" javaType="java.math.BigDecimal"/>

        <result column="record_date" property="recordDate" javaType="java.lang.Long"/>
        <result column="create_time" property="createTime" javaType="java.lang.Long"/>
        <result column="update_time" property="updateTime" javaType="java.lang.Long"/>

        <result column="remark" property="remark" javaType="java.lang.String"/>

    </resultMap>

    <!-- Base columns -->
    <sql id="BaseColumns">
        user_id,
        agent_name,
        order_type,
        order_quantity,
        success_quantity,
        currency,
        commission,
        record_date,
        create_time,
        update_time,
        remark
    </sql>

    <!-- Base columns with alias -->
    <sql id="BaseColumnsWithAlias">
        ar.user_id,
        ar.agent_name,
        ar.order_type,
        ar.order_quantity,
        ar.success_quantity,
        ar.currency,
        ar.commission,
        ar.record_date,
        ar.create_time,
        ar.update_time,
        ar.remark
    </sql>

    <!-- Insert -->
    <insert id="insert" parameterType="com.pakgopay.mapper.dto.AgentReportDto">
        INSERT INTO agent_report (
        <include refid="BaseColumns"/>
        ) VALUES (
        #{userId},
        #{agentName},
        #{orderType},
        #{orderQuantity},
        #{successQuantity},
        #{currency},
        #{commission},
        #{recordDate},
        #{createTime},
        #{updateTime},
        #{remark}
        )
    </insert>

    <!-- Update by unique key -->
    <update id="update" parameterType="com.pakgopay.mapper.dto.AgentReportDto">
        UPDATE agent_report
        <set>
            <if test="agentName != null">agent_name = #{agentName},</if>

            <if test="orderQuantity != null">order_quantity = #{orderQuantity},</if>
            <if test="successQuantity != null">success_quantity = #{successQuantity},</if>

            <if test="commission != null">commission = #{commission},</if>
            <if test="remark != null">remark = #{remark},</if>

            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE user_id = #{userId}
        AND record_date = #{recordDate}
        AND order_type = #{orderType}
        AND currency = #{currency}
    </update>

    <insert id="batchUpsert" parameterType="java.util.List">
        INSERT INTO agent_report (
        <include refid="BaseColumns"/>
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.userId},
            #{item.agentName},
            #{item.orderType},
            #{item.orderQuantity},
            #{item.successQuantity},
            #{item.currency},
            #{item.commission},
            #{item.recordDate},
            #{item.createTime},
            #{item.updateTime},
            #{item.remark}
            )
        </foreach>
        ON CONFLICT (user_id, record_date, order_type, currency) DO UPDATE SET
        agent_name = EXCLUDED.agent_name,
        order_quantity = EXCLUDED.order_quantity,
        success_quantity = EXCLUDED.success_quantity,
        commission = EXCLUDED.commission,
        remark = EXCLUDED.remark,
        update_time = EXCLUDED.update_time
    </insert>

    <!-- Common WHERE conditions for AgentReportQuery -->
    <sql id="AgentReportWhere">
        <where>
            <if test="agentName != null and agentName != ''">
                AND ar.agent_name = #{agentName}
            </if>

            <if test="currency != null and currency != ''">
                AND ar.currency = #{currency}
            </if>

            <if test="orderType != null">
                AND ar.order_type = #{orderType}
            </if>

            <if test="topAgentId != null and topAgentId != ''">
                AND ai.top_agent_id = #{topAgentId}
            </if>
            <if test="maxLevel != null">
                AND ai.level &gt;= #{maxLevel}
            </if>

            <if test="startTime != null">
                AND ar.record_date &gt;= #{startTime}
            </if>

            <if test="endTime != null">
                AND ar.record_date &lt;= #{endTime}
            </if>
        </where>
    </sql>

    <!-- Count -->
    <select id="commissionInfosByQuery"
            parameterType="com.pakgopay.data.entity.report.AgentReportEntity"
            resultType="java.math.BigDecimal">
        SELECT
        ar.commission
        FROM agent_report ar
        LEFT JOIN agent_info ai ON ar.user_id = ai.user_id
        <include refid="AgentReportWhere"/>
    </select>

    <!-- Page query -->
    <select id="pageByQuery"
            parameterType="com.pakgopay.data.entity.report.AgentReportEntity"
            resultMap="AgentReportResultMap">
        SELECT
        <include refid="BaseColumnsWithAlias"/>
        FROM agent_report ar
        LEFT JOIN agent_info ai ON ar.user_id = ai.user_id
        <include refid="AgentReportWhere"/>
        ORDER BY ar.record_date DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


</mapper>
