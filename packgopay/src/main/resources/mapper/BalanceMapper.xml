<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pakgopay.mapper.BalanceMapper">

    <!-- Result map (explicit javaType) -->
    <resultMap id="BalanceResultMap" type="com.pakgopay.mapper.dto.BalanceDto">
        <id column="user_id" property="userId" javaType="java.lang.String"/>

        <id column="currency" property="currency" javaType="java.lang.String"/>
        <result column="available_balance" property="availableBalance" javaType="java.math.BigDecimal"/>
        <result column="frozen_balance" property="frozenBalance" javaType="java.math.BigDecimal"/>
        <result column="withdraw_amount" property="withdrawAmount" javaType="java.math.BigDecimal"/>
        <result column="total_balance" property="totalBalance" javaType="java.math.BigDecimal"/>

        <result column="create_time" property="createTime" javaType="java.lang.Long"/>
        <result column="update_time" property="updateTime" javaType="java.lang.Long"/>

        <result column="remark" property="remark" javaType="java.lang.String"/>
    </resultMap>

    <!-- Base columns -->
    <sql id="BaseColumns">
        user_id,
        currency,
        available_balance,
        frozen_balance,
        withdraw_amount,
        total_balance,
        create_time,
        update_time,
        remark
    </sql>

    <!-- Query by userId -->
    <select id="findByUserId" parameterType="string" resultMap="BalanceResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM balance
        WHERE user_id = #{userId}
    </select>

    <!-- Query by userId and currency -->
    <select id="findByUserIdAndCurrency" resultMap="BalanceResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM balance
        WHERE user_id = #{userId}
            AND currency = #{currency}
        LIMIT 1
    </select>

    <!-- Insert -->
    <insert id="insert" parameterType="com.pakgopay.mapper.dto.BalanceDto">
        INSERT INTO balance (
        <include refid="BaseColumns"/>
        ) VALUES (
        #{userId},
        #{currency},
        #{availableBalance},
        #{frozenBalance},
        #{withdrawAmount},
        #{totalBalance},
        #{createTime},
        #{updateTime},
        #{remark}
        )
    </insert>

    <!-- Update by userId (dynamic set) -->
    <update id="updateByUserId" parameterType="com.pakgopay.mapper.dto.BalanceDto">
        UPDATE balance
        <set>
            <if test="currency != null">currency = #{currency},</if>
            <if test="availableBalance != null">available_balance = #{availableBalance},</if>
            <if test="frozenBalance != null">frozen_balance = #{frozenBalance},</if>
            <if test="withdrawAmount != null">withdraw_amount = #{withdrawAmount},</if>
            <if test="totalBalance != null">total_balance = #{totalBalance},</if>

            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <!-- Freeze available balance (atomic) -->
    <update id="freezeBalance">
        UPDATE balance
        SET
            available_balance = available_balance - #{amount},
            frozen_balance = frozen_balance + #{amount},
            update_time = #{updateTime}
        WHERE user_id = #{userId}
          AND currency = #{currency}
          AND available_balance >= #{amount}
    </update>

    <!-- Atomic add available balance -->
    <update id="addAvailableBalance">
        UPDATE balance
        SET
            available_balance = COALESCE(available_balance, 0) + #{delta},
            total_balance = COALESCE(total_balance, 0) + #{delta},
            update_time = #{updateTime}
        WHERE user_id = #{userId}
            AND currency = #{currency}
            AND (#{delta} &gt;= 0 OR available_balance &gt;= -#{delta})
    </update>

    <!-- Atomic add frozen balance (usually total_balance unchanged; adjust if your business differs) -->
    <update id="addFrozenBalance">
        UPDATE balance
        SET
            frozen_balance = COALESCE(frozen_balance, 0) + #{delta},
            update_time = #{updateTime}
        WHERE user_id = #{userId}
          AND currency = #{currency}
    </update>

    <!-- Release frozen balance to available (total unchanged) -->
    <update id="releaseFrozenBalance">
        UPDATE balance
        SET
            frozen_balance = COALESCE(frozen_balance, 0) - #{amount},
            available_balance = COALESCE(available_balance, 0) + #{amount},
            update_time = #{updateTime}
        WHERE user_id = #{userId}
          AND currency = #{currency}
          AND frozen_balance &gt;= #{amount}
    </update>

    <select id="listByUserIds" resultMap="BalanceResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM balance
        <if test="userIds != null and userIds.size() > 0">
            WHERE user_id IN
            <foreach collection="userIds" item="uid" open="(" close=")" separator=",">
                #{uid}
            </foreach>
        </if>
    </select>

    <update id="adjustBalance">
        UPDATE balance
        SET
            available_balance = available_balance + #{amount},
            total_balance = total_balance + #{amount},
            update_time = #{now}
        WHERE user_id = #{userId}
          AND currency = #{currency}
          AND (#{amount} &gt;= 0 OR available_balance &gt;= -#{amount})
    </update>

    <update id="freezeForWithdraw">
        UPDATE balance
        SET
            available_balance = available_balance - #{amount},
            frozen_balance = frozen_balance + #{amount},
            update_time = #{now}
        WHERE user_id = #{userId}
          AND currency = #{currency}
          AND available_balance >= #{amount}
    </update>

    <update id="confirmWithdraw">
        UPDATE balance
        SET
            frozen_balance = frozen_balance - #{amount},
            withdraw_amount = COALESCE(withdraw_amount, 0) + #{amount},
            update_time = #{now}
        WHERE user_id = #{userId}
          AND currency = #{currency}
          AND frozen_balance >= #{amount}
    </update>

    <update id="cancelWithdraw">
        UPDATE balance
        SET
            frozen_balance = frozen_balance - #{amount},
            available_balance = available_balance + #{amount},
            update_time = #{now}
        WHERE user_id = #{userId}
          AND currency = #{currency}
          AND frozen_balance >= #{amount}
    </update>

    <update id="confirmPayoutBalance">
        UPDATE balance
        SET
            frozen_balance = frozen_balance - #{amount},
            total_balance = total_balance - #{amount},
            update_time = #{now}
        WHERE user_id = #{userId}
          AND currency = #{currency}
          AND frozen_balance >= #{amount}
    </update>

</mapper>
