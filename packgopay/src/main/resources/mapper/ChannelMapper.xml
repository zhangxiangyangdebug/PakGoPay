<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pakgopay.mapper.ChannelMapper">

    <resultMap id="ChannelResultMap" type="com.pakgopay.mapper.dto.ChannelDto">

        <id     column="channel_id" property="channelId" javaType="java.lang.Long"/>

        <result column="channel_name" property="channelName" javaType="java.lang.String"/>

        <result column="total_count" property="totalCount" javaType="java.lang.Long"/>
        <result column="fail_count" property="failCount" javaType="java.lang.Long"/>

        <result column="success_rate" property="successRate" javaType="java.math.BigDecimal"/>

        <result column="update_time" property="updateTime" javaType="java.lang.Long"/>
        <result column="update_by" property="updateBy" javaType="java.lang.String"/>

        <result column="create_time" property="createTime" javaType="java.lang.Long"/>
        <result column="create_by" property="createBy" javaType="java.lang.String"/>

        <result column="status" property="status" javaType="java.lang.Integer"/>

        <result column="remark" property="remark" javaType="java.lang.String"/>

        <result column="payment_ids" property="paymentIds" javaType="java.lang.String"/>

    </resultMap>

    <sql id="BaseColumns">
        channel_id,
        channel_name,
        total_count,
        fail_count,
        success_rate,
        update_time,
        update_by,
        create_time,
        create_by,
        status,
        remark,
        payment_ids
    </sql>

    <!-- findByChannelId -->
    <select id="findByChannelId" resultMap="ChannelResultMap">
        select <include refid="BaseColumns"/>
        from channel
        where channel_id = #{channelId}
        limit 1
    </select>

    <!-- getAllChannels -->
    <select id="getAllChannels" resultMap="ChannelResultMap">
        select <include refid="BaseColumns"/>
        from channel
        order by create_time desc
    </select>

    <!-- insert -->
    <insert id="insert" parameterType="com.pakgopay.mapper.dto.ChannelDto">
        insert into channel (
        <include refid="BaseColumns"/>
        ) values (
        #{channelId},
        #{channelName},
        #{totalCount},
        #{failCount},
        #{successRate},
        #{updateTime},
        #{updateBy},
        #{createTime},
        #{createBy},
        #{status},
        #{remark},
        #{paymentIds}
        )
    </insert>

    <!-- updateByChannelId -->
    <update id="updateByChannelId" parameterType="com.pakgopay.mapper.dto.ChannelDto">
        update channel
        set
            channel_name = #{channelName},
            total_count = #{totalCount},
            fail_count = #{failCount},
            success_rate = #{successRate},
            update_time = #{updateTime},
            update_by = #{updateBy},
            create_time = #{createTime},
            create_by = #{createBy},
            status = #{status},
            remark = #{remark},
            payment_ids = #{paymentIds}
        where channel_id = #{channelId}
    </update>

    <!-- deleteByChannelId -->
    <delete id="deleteByChannelId">
        delete from channel
        where channel_id = #{channelId}
    </delete>

    <!-- getPaymentNosByChannelIds -->
    <select id="getPaymentIdsByChannelIds" resultMap="ChannelResultMap">
        select
        channel_id,
        payment_ids,
        channel_name
        from channel
        where channel_id in
        <if test="channelIds == null or channelIds.isEmpty()">
            1 = 0
        </if>
        <if test="channelIds != null and !channelIds.isEmpty()">
            <foreach collection="channelIds" item="id" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        <if test="status != null">
            and status = #{status}
        </if>
    </select>

    <sql id="ChannelQueryWhere">
        <where>

            <if test="channelId != null">
                AND channel_id = #{channelId}
            </if>

            <if test="channelName != null and channelName != ''">
                AND channel_name LIKE CONCAT('%', #{channelName}, '%')
            </if>

            <if test="paymentId != null and paymentId != ''">
                AND (
                payment_ids = #{paymentId}
                OR payment_ids LIKE CONCAT('%,', #{paymentId})
                OR payment_ids LIKE CONCAT(#{paymentId}, ',%')
                OR payment_ids LIKE CONCAT('%,',#{paymentId}, ',%')
                )
            </if>

            <if test="currency != null and currency != ''">
                AND currency = #{currency}
            </if>

            <if test="status != null">
                AND status = #{status}
            </if>

        </where>
    </sql>

    <select id="countByQuery"
            parameterType="com.pakgopay.entity.channel.ChannelEntity"
            resultType="int">
        SELECT COUNT(1)
        FROM channel
        <include refid="ChannelQueryWhere"/>
    </select>

    <select id="pageByQuery"
            parameterType="com.pakgopay.entity.channel.ChannelEntity"
            resultMap="ChannelResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM channel
        <include refid="ChannelQueryWhere"/>
        ORDER BY channel_id DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


</mapper>
