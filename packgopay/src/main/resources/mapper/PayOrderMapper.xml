<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pakgopay.mapper.PayOrderMapper">

    <!-- Result map (explicit javaType) -->
    <resultMap id="PayOrderResultMap" type="com.pakgopay.mapper.dto.PayOrderDto">
        <id column="transaction_no" property="transactionNo" javaType="java.lang.String"/>
        <id column="merchant_order_no" property="merchantOrderNo" javaType="java.lang.String"/>

        <result column="amount" property="amount" javaType="java.math.BigDecimal"/>
        <result column="actual_amount" property="actualAmount" javaType="java.math.BigDecimal"/>

        <result column="callback_token" property="callbackToken" javaType="java.lang.String"/>
        <result column="callback_url" property="callbackUrl" javaType="java.lang.String"/>
        <result column="callback_times" property="callbackTimes" javaType="java.lang.Integer"/>

        <!-- Note: DB column name is last_callbak_time -->
        <result column="last_callbak_time" property="lastCallbackTime" javaType="java.lang.Long"/>
        <result column="success_callback_time" property="successCallbackTime" javaType="java.lang.Long"/>
        <result column="callback_status" property="callbackStatus" javaType="java.lang.Integer"/>

        <result column="merchant_user_id" property="merchantUserId" javaType="java.lang.String"/>

        <result column="merchant_fixed_fee" property="merchantFixedFee" javaType="java.math.BigDecimal"/>
        <result column="merchant_rate" property="merchantRate" javaType="java.math.BigDecimal"/>
        <result column="merchant_fee" property="merchantFee" javaType="java.math.BigDecimal"/>

        <result column="agent1_fixed_fee" property="agent1FixedFee" javaType="java.math.BigDecimal"/>
        <result column="agent1_rate" property="agent1Rate" javaType="java.math.BigDecimal"/>
        <result column="agent1_fee" property="agent1Fee" javaType="java.math.BigDecimal"/>

        <!-- Note: DB columns are agnet2_* / agnet3_* -->
        <result column="agnet2_fixed_fee" property="agent2FixedFee" javaType="java.math.BigDecimal"/>
        <result column="agnet2_rate" property="agent2Rate" javaType="java.math.BigDecimal"/>
        <result column="agnet2_fee" property="agent2Fee" javaType="java.math.BigDecimal"/>

        <result column="agnet3_fixed_fee" property="agent3FixedFee" javaType="java.math.BigDecimal"/>
        <result column="agnet3_rate" property="agent3Rate" javaType="java.math.BigDecimal"/>
        <result column="agnet3_fee" property="agent3Fee" javaType="java.math.BigDecimal"/>

        <result column="request_ip" property="requestIp" javaType="java.lang.String"/>

        <result column="create_time" property="createTime" javaType="java.lang.Long"/>
        <result column="update_time" property="updateTime" javaType="java.lang.Long"/>
        <result column="request_time" property="requestTime" javaType="java.lang.Long"/>

        <result column="order_type" property="orderType" javaType="java.lang.Integer"/>
        <result column="payment_mode" property="paymentMode" javaType="java.lang.Integer"/>

        <result column="payment_id" property="paymentId" javaType="java.lang.Long"/>
        <result column="channel_id" property="channelId" javaType="java.lang.Long"/>

        <result column="order_status" property="orderStatus" javaType="java.lang.String"/>
        <result column="remark" property="remark" javaType="java.lang.String"/>
        <result column="currency_type" property="currencyType" javaType="java.lang.String"/>

        <result column="operate_type" property="operateType" javaType="java.lang.Integer"/>
    </resultMap>

    <resultMap id="MerchantReportResultMap" type="com.pakgopay.mapper.dto.MerchantReportDto">
        <result column="merchant_user_id" property="userId"/>
        <result column="currency_type" property="currency"/>
        <result column="order_quantity" property="orderQuantity"/>
        <result column="success_quantity" property="successQuantity"/>
        <result column="merchant_fee" property="merchantFee"/>
        <result column="agent1_fee" property="agent1Fee"/>
        <result column="agent2_fee" property="agent2Fee"/>
        <result column="agent3_fee" property="agent3Fee"/>
    </resultMap>

    <resultMap id="ChannelReportResultMap" type="com.pakgopay.mapper.dto.ChannelReportDto">
        <result column="channel_id" property="channelId"/>
        <result column="currency_type" property="currency"/>
        <result column="order_quantity" property="orderQuantity"/>
        <result column="success_quantity" property="successQuantity"/>
        <result column="order_balance" property="orderBalance"/>
        <result column="merchant_fee" property="merchantFee"/>
        <result column="order_profit" property="orderProfit"/>
    </resultMap>

    <resultMap id="PaymentReportResultMap" type="com.pakgopay.mapper.dto.PaymentReportDto">
        <result column="payment_id" property="paymentId"/>
        <result column="currency_type" property="currency"/>
        <result column="order_quantity" property="orderQuantity"/>
        <result column="success_quantity" property="successQuantity"/>
        <result column="order_balance" property="orderBalance"/>
        <result column="merchant_fee" property="merchantFee"/>
        <result column="order_profit" property="orderProfit"/>
    </resultMap>

    <resultMap id="CurrencyReportResultMap" type="com.pakgopay.mapper.dto.CurrencyReportDto">
        <result column="currency_type" property="currency"/>
        <result column="order_quantity" property="orderQuantity"/>
        <result column="success_quantity" property="successQuantity"/>
        <result column="order_balance" property="orderBalance"/>
        <result column="merchant_fee" property="merchantFee"/>
        <result column="order_profit" property="orderProfit"/>
    </resultMap>

    <!-- Base columns -->
    <sql id="BaseColumns">
        transaction_no,merchant_order_no,amount,actual_amount,callback_token,callback_url,callback_times,last_callbak_time,success_callback_time,callback_status,merchant_user_id,
        merchant_fixed_fee,merchant_rate,merchant_fee,agent1_fixed_fee,agent1_rate,agent1_fee,agnet2_fixed_fee,agnet2_rate,agnet2_fee,agnet3_fixed_fee,agnet3_rate,agnet3_fee,
        request_ip,create_time,update_time,request_time,order_type,payment_mode,payment_id,channel_id,order_status,
        remark,currency_type,operate_type
    </sql>

    <!-- Insert -->
    <insert id="insert" parameterType="com.pakgopay.mapper.dto.PayOrderDto">
        INSERT INTO pay_order (
        <include refid="BaseColumns"/>
        ) VALUES (
        #{transactionNo},#{merchantOrderNo},#{amount},#{actualAmount},#{callbackToken},#{callbackUrl},#{callbackTimes},#{lastCallbackTime},#{successCallbackTime},#{callbackStatus},#{merchantUserId},
        #{merchantFixedFee},#{merchantRate},#{merchantFee},#{agent1FixedFee},#{agent1Rate},#{agent1Fee},#{agent2FixedFee},#{agent2Rate},#{agent2Fee},#{agent3FixedFee},#{agent3Rate},#{agent3Fee},
        #{requestIp},#{createTime},#{updateTime},#{requestTime},#{orderType},#{paymentMode},#{paymentId},#{channelId},#{orderStatus},
        #{remark},#{currencyType},#{operateType}
        )
    </insert>

    <!-- Query by order ID -->
    <select id="findByTransactionNo" parameterType="string" resultMap="PayOrderResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM pay_order
        WHERE transaction_no = #{transactionNo}
        LIMIT 1
    </select>

    <!-- Check if merchant order number exists -->
    <select id="isExitMerchantOrderNo" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM pay_order
        WHERE merchant_order_no = #{merchantOrderNo}
    </select>

    <!-- Update by transaction_no (update non-null fields only) -->
    <update id="updateByTransactionNo">
        UPDATE pay_order
        <set>
            <include refid="PayOrderUpdateSetDto"/>
        </set>
        WHERE transaction_no = #{dto.transactionNo}
    </update>

    <update id="updateByTransactionNoWhenProcessing">
        UPDATE pay_order
        <set>
            <include refid="PayOrderUpdateSetDto"/>
        </set>
        WHERE transaction_no = #{dto.transactionNo}
          AND order_status = #{currentStatus}
    </update>

    <sql id="PayOrderUpdateSetDto">
        <if test="dto.merchantOrderNo != null">merchant_order_no = #{dto.merchantOrderNo},</if>
        <if test="dto.amount != null">amount = #{dto.amount},</if>
        <if test="dto.actualAmount != null">actual_amount = #{dto.actualAmount},</if>

        <if test="dto.callbackToken != null">callback_token = #{dto.callbackToken},</if>
        <if test="dto.callbackUrl != null">callback_url = #{dto.callbackUrl},</if>
        <if test="dto.callbackTimes != null">callback_times = #{dto.callbackTimes},</if>
        <if test="dto.lastCallbackTime != null">last_callbak_time = #{dto.lastCallbackTime},</if>
        <if test="dto.successCallbackTime != null">success_callback_time = #{dto.successCallbackTime},</if>
        <if test="dto.callbackStatus != null">callback_status = #{dto.callbackStatus},</if>

        <if test="dto.merchantFixedFee != null">merchant_fixed_fee = #{dto.merchantFixedFee},</if>
        <if test="dto.merchantRate != null">merchant_rate = #{dto.merchantRate},</if>
        <if test="dto.merchantFee != null">merchant_fee = #{dto.merchantFee},</if>

        <if test="dto.agent1FixedFee != null">agent1_fixed_fee = #{dto.agent1FixedFee},</if>
        <if test="dto.agent1Rate != null">agent1_rate = #{dto.agent1Rate},</if>
        <if test="dto.agent1Fee != null">agent1_fee = #{dto.agent1Fee},</if>

        <if test="dto.agent2FixedFee != null">agnet2_fixed_fee = #{dto.agent2FixedFee},</if>
        <if test="dto.agent2Rate != null">agnet2_rate = #{dto.agent2Rate},</if>
        <if test="dto.agent2Fee != null">agnet2_fee = #{dto.agent2Fee},</if>

        <if test="dto.agent3FixedFee != null">agnet3_fixed_fee = #{dto.agent3FixedFee},</if>
        <if test="dto.agent3Rate != null">agnet3_rate = #{dto.agent3Rate},</if>
        <if test="dto.agent3Fee != null">agnet3_fee = #{dto.agent3Fee},</if>

        <if test="dto.requestIp != null">request_ip = #{dto.requestIp},</if>

        <if test="dto.orderType != null">order_type = #{dto.orderType},</if>
        <if test="dto.paymentMode != null">payment_mode = #{dto.paymentMode},</if>

        <if test="dto.orderStatus != null">order_status = #{dto.orderStatus},</if>
        <if test="dto.remark != null">remark = #{dto.remark},</if>
        <if test="dto.currencyType != null and dto.currencyType != ''">currency_type = #{dto.currencyType},</if>
        <if test="dto.operateType != null">operate_type = #{dto.operateType},</if>

        <if test="dto.updateTime != null">update_time = #{dto.updateTime},</if>
    </sql>

    <!-- Increase callback retry times (atomic) -->
    <update id="increaseCallbackTimes">
        UPDATE pay_order
        SET
            callback_times = IFNULL(callback_times, 0) + 1,
            last_callbak_time = #{lastCallbackTime},
            update_time = #{lastCallbackTime}
        WHERE transaction_no = #{transactionNo}
    </update>

    <!-- Query by payment IDs and time range -->
    <select id="getPayOrderInfosByPaymentIds" resultMap="PayOrderResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM pay_order
        <where>
            <if test="paymentIds == null or paymentIds.isEmpty()">
                1 = 0
            </if>
            <if test="paymentIds != null and !paymentIds.isEmpty()">
                payment_id IN
                <foreach collection="paymentIds" item="pid" open="(" close=")" separator=",">
                    #{pid}
                </foreach>
                <if test="startTime != null">
                    AND create_time &gt;= #{startTime}
                </if>
                <if test="endTime != null">
                    AND create_time &lt; #{endTime}
                </if>
            </if>
        </where>
    </select>

    <sql id="CommonReportAggColumns">
        COUNT(1) order_quantity,
        IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN 1 ELSE 0 END), 0) success_quantity,
        IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN merchant_fee ELSE 0 END), 0) merchant_fee,
        IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN agent1_fee ELSE 0 END), 0) agent1_fee,
        IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN agnet2_fee ELSE 0 END), 0) agent2_fee,
        IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN agnet3_fee ELSE 0 END), 0) agent3_fee
    </sql>

    <sql id="CommonReportAggColumnsWithBalance">
        COUNT(1) order_quantity,
        IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN 1 ELSE 0 END), 0) success_quantity,
        IFNULL(SUM(IFNULL(actual_amount, amount)), 0) order_balance,
        IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN merchant_fee ELSE 0 END), 0) merchant_fee,
        IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN merchant_fee ELSE 0 END), 0)
          - IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN agent1_fee ELSE 0 END), 0)
          - IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN agnet2_fee ELSE 0 END), 0)
          - IFNULL(SUM(CASE WHEN order_status = #{successStatus} THEN agnet3_fee ELSE 0 END), 0) order_profit
    </sql>

    <select id="listMerchantReportStatsBatch" resultMap="MerchantReportResultMap">
        <foreach collection="ranges" item="item" separator=" UNION ALL ">
            SELECT
                merchant_user_id,
                currency_type,
                <include refid="CommonReportAggColumns"/>
            FROM pay_order
            WHERE currency_type = #{item.currency}
              AND create_time &gt;= #{item.startTime}
              AND create_time &lt; #{item.endTime}
            GROUP BY merchant_user_id, currency_type
        </foreach>
    </select>

    <select id="listChannelReportStatsBatch" resultMap="ChannelReportResultMap">
        <foreach collection="ranges" item="item" separator=" UNION ALL ">
            SELECT
                channel_id,
                currency_type,
                <include refid="CommonReportAggColumnsWithBalance"/>
            FROM pay_order
            WHERE currency_type = #{item.currency}
              AND create_time &gt;= #{item.startTime}
              AND create_time &lt; #{item.endTime}
            GROUP BY channel_id, currency_type
        </foreach>
    </select>

    <select id="listPaymentReportStatsBatch" resultMap="PaymentReportResultMap">
        <foreach collection="ranges" item="item" separator=" UNION ALL ">
            SELECT
                payment_id,
                currency_type,
                <include refid="CommonReportAggColumnsWithBalance"/>
            FROM pay_order
            WHERE currency_type = #{item.currency}
              AND create_time &gt;= #{item.startTime}
              AND create_time &lt; #{item.endTime}
            GROUP BY payment_id, currency_type
        </foreach>
    </select>

    <select id="listCurrencyReportStatsBatch" resultMap="CurrencyReportResultMap">
        <foreach collection="ranges" item="item" separator=" UNION ALL ">
            SELECT
                currency_type,
                <include refid="CommonReportAggColumnsWithBalance"/>
            FROM pay_order
            WHERE currency_type = #{item.currency}
              AND create_time &gt;= #{item.startTime}
              AND create_time &lt; #{item.endTime}
            GROUP BY currency_type
        </foreach>
    </select>

    <select id="countByQuery" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM pay_order
        <where>
            <if test="q != null and q.merchantUserId != null and q.merchantUserId != ''">
                merchant_user_id = #{q.merchantUserId}
            </if>
            <if test="q != null and q.transactionNo != null and q.transactionNo != ''">
                AND transaction_no = #{q.transactionNo}
            </if>
            <if test="q != null and q.merchantOrderNo != null and q.merchantOrderNo != ''">
                AND merchant_order_no = #{q.merchantOrderNo}
            </if>
            <if test="q != null and q.currencyType != null and q.currencyType != ''">
                AND currency_type = #{q.currencyType}
            </if>
            <if test="q != null and q.orderStatus != null and q.orderStatus != ''">
                AND order_status = #{q.orderStatus}
            </if>
            <if test="q != null and q.orderType != null">
                AND order_type = #{q.orderType}
            </if>
            <if test="q != null and q.amount != null">
                AND amount = #{q.amount}
            </if>
            <if test="q != null and q.channelId != null">
                AND channel_id = #{q.channelId}
            </if>
            <if test="q != null and q.startTime != null">
                AND create_time &gt;= #{q.startTime}
            </if>
            <if test="q != null and q.endTime != null">
                AND create_time &lt; #{q.endTime}
            </if>
        </where>
    </select>

    <select id="pageByQuery" resultMap="PayOrderResultMap">
        SELECT
        <include refid="BaseColumns"/>
        FROM pay_order
        <where>
            <if test="q != null and q.merchantUserId != null and q.merchantUserId != ''">
                merchant_user_id = #{q.merchantUserId}
            </if>
            <if test="q != null and q.transactionNo != null and q.transactionNo != ''">
                AND transaction_no = #{q.transactionNo}
            </if>
            <if test="q != null and q.merchantOrderNo != null and q.merchantOrderNo != ''">
                AND merchant_order_no = #{q.merchantOrderNo}
            </if>
            <if test="q != null and q.currencyType != null and q.currencyType != ''">
                AND currency_type = #{q.currencyType}
            </if>
            <if test="q != null and q.orderStatus != null and q.orderStatus != ''">
                AND order_status = #{q.orderStatus}
            </if>
            <if test="q != null and q.orderType != null">
                AND order_type = #{q.orderType}
            </if>
            <if test="q != null and q.amount != null">
                AND amount = #{q.amount}
            </if>
            <if test="q != null and q.channelId != null">
                AND channel_id = #{q.channelId}
            </if>
            <if test="q != null and q.startTime != null">
                AND create_time &gt;= #{q.startTime}
            </if>
            <if test="q != null and q.endTime != null">
                AND create_time &lt; #{q.endTime}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{q.pageSize} OFFSET #{q.offset}
    </select>

</mapper>
